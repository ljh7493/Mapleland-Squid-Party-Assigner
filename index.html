<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ¦‘ ì›ì–‘ì–´ì„  ìë™ ë°°ì •ê¸°</title>
  <style>
    body { margin:0; padding:24px; font-family:'Malgun Gothic',sans-serif; background:#001f33; color:#fff; display:flex; flex-direction:column; align-items:center; min-height:100vh; box-sizing:border-box; }
    h1 { margin-bottom:16px; font-size:1.5rem; text-align:center; }
    textarea { width:100%; max-width:700px; height:210px; margin-bottom:16px; padding:12px; font-size:14px; border:none; border-radius:12px; resize:vertical; box-shadow:0 2px 8px rgba(0,0,0,0.2); background:#002a4d; color:#eee; }
    .button-group { display:flex; gap:12px; margin-bottom:12px; width:100%; max-width:700px; }
    button { padding:10px 18px; font-size:14px; border:none; border-radius:8px; cursor:pointer; background:#004aad; color:#fff; transition:0.2s; }
    button:disabled { background:#555!important; cursor:not-allowed; }
    button:hover:enabled { background:#003080; }
    @media(max-width:600px){ .button-group{justify-content:center;} }
    .tooltip { position:relative; display:inline-block; margin-left:8px; cursor:help; }
    .tooltip .tiptext { 
      visibility:hidden;
      width:320px;
      background:#222;
      color:#fff;
      padding:12px;
      border-radius:6px;
      position:absolute;
      z-index:1;
      top:100%;
      left:50%;
      transform:translateX(-40%) translateY(8px);
      opacity:0;
      transition:opacity 0.3s;
      font-size:13px;
      line-height:1.4;
      text-align:left;
    }
    .tooltip:hover .tiptext { visibility:visible; opacity:1; }
  </style>
</head>
<body>
  <h1>
    <span class="tooltip">ğŸ¦‘ ì›ì–‘ì–´ì„  ìë™ ë°°ì •ê¸°
      <div class="tiptext">
        <strong>ë°°ì • ê¸°ì¤€ ìš”ì•½</strong><br>
        â€¢ ìˆ«ì ê¸¸ì´ë¡œ êµ¬ë¶„: 2~3ìë¦¬â†’ë ˆë²¨, 4ìë¦¬ ì´ìƒâ†’ê³µê²©ë ¥, 1ìë¦¬â†’ë¬´ì‹œ<br>
        â€¢ ê³µê²©ë ¥ ë’¤ â€œë©”ìš©/ë©”â€ í‘œì‹œ ì‹œ 5% ê°ì‚°<br>
        â€¢ ë ˆë²¨ 97ë¯¸ë§Œì¼ ë• ë ˆë²¨ì°¨ Ã—1% ì¶”ê°€ ê°ì‚°<br>
        â€¢ ê³µê²©ë ¥ ë¹„êµëŠ” ë ˆì¸ì € ê¸°ì¤€ ë³´ì •ê°’ ì ìš©:<br>
          â€“ ë‚˜ì´íŠ¸ë¡œë“œ(+550), í—ˆë°‹(+500), ì €ê²©ìˆ˜Â·ì‹ ê¶(â€“150)<br>
        â€¢ íŠ¹ì • ì§ì—… ê³ ì •ë°°ì¹˜:<br>
          â€“ ì‹œí”„ë§ˆìŠ¤í„°, í¬ë£¨ì„¸ì´ë”, ìš©ê¸°ì‚¬ëŠ” ìš°ì„  ë°°ì¹˜ ìœ„ì¹˜ ì§€ì •<br>
        â€¢ ì„ ì¥ì€ ë ˆë²¨Â·ì§ì—…Â·ê³µê²©ë ¥ ëˆ„ë½ ì‹œì—ë„ 5ì¸µ í™•ì •<br>
        â€» ì ˆëŒ€ì ì¸ ê¸°ì¤€ì´ ì•„ë‹Œ ë‹¨ìˆœ ì°¸ê³ ìš©ì…ë‹ˆë‹¤.<br>
        ê²°ê³¼ì— ì´ìƒì´ ìˆëŠ” ê²½ìš° ì ì ˆíˆ íŒë‹¨í•˜ì—¬ ë°°ì •í•˜ì„¸ìš”.
      </div>
    </span>
  </h1>

  <textarea id="input" placeholder="êµ¬ì¸ê¸€ì„ ë¶™ì—¬ë„£ì–´ì£¼ì„¸ìš”."></textarea>
  <div class="button-group">
    <button id="btn-assign">ë°°ì •í•˜ê¸°</button>
    <button id="btn-clear">ì§€ìš°ê¸°</button>
    <button id="btn-copy" disabled>ê²°ê³¼ë³µì‚¬</button>
  </div>
  <textarea id="output" readonly placeholder="ë°°ì • ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤."></textarea>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const jobMap = { ë³´ë§ˆ:'ë³´ìš°ë§ˆìŠ¤í„°', ì‹ ê¶:'ì‹ ê¶', ë³´ìš°ë§ˆìŠ¤í„°:'ë³´ìš°ë§ˆìŠ¤í„°', ë Œ:'ë ˆì¸ì €', ë Œì ¸:'ë ˆì¸ì €', ë ˆì¸ì ¸:'ë ˆì¸ì €', ë ê±°:'ë ˆì¸ì €', ë ˆì¸ì €:'ë ˆì¸ì €', ì €ê²©:'ì €ê²©ìˆ˜', ì €ìˆ˜:'ì €ê²©ìˆ˜', ì €ê²©ìˆ˜:'ì €ê²©ìˆ˜', í—ˆë°‹:'í—ˆë°‹', í‘œë„:'í—ˆë°‹', í—ˆ:'í—ˆë°‹', ë‚˜ë¡œ:'ë‚˜ì´íŠ¸ë¡œë“œ', ë‚˜ì´íŠ¸ë¡œë“œ:'ë‚˜ì´íŠ¸ë¡œë“œ', ìš©:'ìš©ê¸°ì‚¬', ìš©ê¸°ì‚¬:'ìš©ê¸°ì‚¬', í¬ë£¨:'í¬ë£¨ì„¸ì´ë”', í¬ë£¨ì„¸ì´ë”:'í¬ë£¨ì„¸ì´ë”', ì‹œí”„:'ì‹œí”„ë§ˆìŠ¤í„°', ì‹œí”„ë§ˆìŠ¤í„°:'ì‹œí”„ë§ˆìŠ¤í„°', ì‹œë§ˆ:'ì‹œí”„ë§ˆìŠ¤í„°', ë‹¤í¬ë‚˜ì´íŠ¸:'ë‹¤í¬ë‚˜ì´íŠ¸', ë‹¼ë‚˜:'ë‹¤í¬ë‚˜ì´íŠ¸', í˜€ë¡œ:'íˆì–´ë¡œ', íˆì–´ë¡œ:'íˆì–´ë¡œ', ì„€ë„ì–´:'ì„€ë„ì–´' };
    const conv = { ë‚˜ì´íŠ¸ë¡œë“œ:550, í—ˆë°‹:500, ì €ê²©ìˆ˜:-150, ì‹ ê¶:-150 };

    function parseLine(line) {
      let txt = line.replace(/^\d+\s*(?:\.\s*)?/, '').replace(/[\[\]():]/g,'/').trim();
      const parts = txt.split(/[\/\s]+/).filter(Boolean);
      let lvlRaw='', atkRaw='', buffTag='', jobRaw='', nick=[];
      for (let tk of parts) {
        // ìˆ˜ì¹˜ ë’¤ ë©”ì—…* íŒ¨í„´ ë¬´ì‹œ
        let mU = tk.match(/^(\d{4,}\+*)(?:ë©”ì—…m?|ë©”ì—…M?|ë©”ì†Œì—…m?|ë©”ì†Œì—…M?)$/i);
        if (mU && !atkRaw) { atkRaw = mU[1]; continue; }
        // ë‹¨ë… 'ë©”ìš©'
        if (/^ë©”ìš©$/i.test(tk)) { buffTag='ë©”ìš©'; continue; }
        // '(ë©”ìš©)' ì ‘ë¯¸ì‚¬
        let mMe = tk.match(/^(\d{4,}\+*)\(ë©”ìš©\)$/i);
        if (mMe && !atkRaw) { atkRaw=mMe[1]; buffTag='ë©”ìš©'; continue; }
        // ë ˆë²¨
        if (!lvlRaw && /^\d{2,3}n?$/i.test(tk)) { lvlRaw=tk; continue; }
        // ê³µê²©ë ¥
        if (!atkRaw && /^\d{4,}\+*$/.test(tk)) { atkRaw=tk; continue; }
        // ì§ì—…
        const norm = jobMap[tk.toLowerCase()]; if (!jobRaw && norm) { jobRaw=norm; continue; }
        // ê¸°íƒ€ ë©”ì—… ë“± ë¬´ì‹œ
        if (/^ë©”ì—…/i.test(tk) || /^ë©”ì†Œì—…/i.test(tk)) continue;
        nick.push(tk);
      }
      if (!atkRaw && ['ë³´ìš°ë§ˆìŠ¤í„°','ì‹ ê¶'].includes(jobRaw)) atkRaw='9999+';
      if (!lvlRaw) lvlRaw='?'; if (!jobRaw) jobRaw='ë³´ìš°ë§ˆìŠ¤í„°';
      if (!nick.length || !atkRaw) throw new Error('í•„ìˆ˜ í•„ë“œ ëˆ„ë½');
      return { nick:nick.join(' '), lvlRaw, jobRaw, atkRaw, buffTag };
    }

    function processInput(text) {
      const lines = text.split('\n').map(l => l.trim());
      let players = [], errors = [], reductions = [], noReduce = [];
      for (let line of lines) {
        if (!/^\d+/.test(line)) continue;
        const idx = parseInt(line, 10);
        let useLine = line;
        if (idx === 1 && !line.includes('/')) {
          const lvlM = line.match(/\b(\d{2,3}n?)\b/);
          const lvlR = lvlM ? lvlM[1] : '?';
          const atkM = line.match(/(\d{4,}\+*)/);
          const atkR = atkM ? atkM[1] : '';
          const jobM = line.match(/ë³´ë§ˆ|ì‹ ê¶|ë Œì ¸?|ë Œì €|ë ˆì¸ì €|ì €ê²©ìˆ˜|í—ˆë°‹/i);
          const jobR = jobM ? jobMap[jobM[0].toLowerCase()] : 'ë³´ìš°ë§ˆìŠ¤í„°';
          useLine = `1. ì„ ì¥/${lvlR}/${jobR}/${atkR}`;
        }
        try {
          const { nick, lvlRaw, jobRaw, atkRaw, buffTag } = parseLine(useLine);
          const rawAtk = parseInt(atkRaw, 10);
          let lvl = parseInt(lvlRaw) || 97;
          let unknown = false;
          if (lvlRaw === '?' || /n$/i.test(lvlRaw)) { unknown = true; lvl = 97; noReduce.push(nick + '(ë ˆë²¨ë¯¸í™•ì¸)'); }
          if (!unknown && lvl < 92) throw new Error();
          let adj = rawAtk;
          if (buffTag === 'ë©”ìš©') { const bef = adj; adj = Math.round(adj / 1.05); reductions.push(`${nick}/${bef}â†’${adj}(ë©”ìš© ê°ì‚°)`); }
          if (!unknown && lvl < 97) { const bef = adj; const pct = (97 - lvl) / 100; adj = Math.round(adj * (1 - pct)); reductions.push(`${nick}/${bef}â†’${adj}(ë ˆë²¨${Math.round(pct * 100)}%)`); }
          players.push({ nick, lvl, job: jobRaw, adj, comp: adj + (conv[jobRaw] || 0), display: `${nick}/${lvlRaw}/${jobRaw}/${atkRaw}` });
        } catch (e) {
          errors.push(line);
        }
      }
      if (players.length < 5) {
        return 'ë°°ì • ì‹¤íŒ¨\nâ€» íŒŒì‹± ì‹¤íŒ¨ ë¼ì¸:\n' + errors.join('\n');
      }
      // íŒŒí‹°ì› ë°°ì¹˜
      players.sort((a, b) => b.comp - a.comp);
      const map = {};
      let remaining = [...players];
      // ì‹œí”„ë§ˆìŠ¤í„° 4ì¸µ ê³ ì •
      const shif = remaining.find(p => p.job === 'ì‹œí”„ë§ˆìŠ¤í„°');
      if (shif) { map['4ì¸µ'] = shif; remaining = remaining.filter(p => p !== shif); }
      // í¬ë£¨ì„¸ì´ë” vs ìš©ê¸°ì‚¬
      const crs = remaining.filter(p => ['í¬ë£¨ì„¸ì´ë”', 'ìš©ê¸°ì‚¬'].includes(p.job));
      crs.sort((a, b) => b.comp - a.comp);
      if (crs[0]) { map['1ì¸µ'] = crs[0]; remaining = remaining.filter(p => p !== crs[0]); }
      if (crs[1]) { map['3ì¸µ'] = crs[1]; remaining = remaining.filter(p => p !== crs[1]); }
      // ë‚˜ë¨¸ì§€ ë°°ì¹˜
      const assignOrder = ['5ì¸µ','3ì¸µ','1ì¸µ','2ì¸µ','4ì¸µ'];
      for (let floor of assignOrder) { if (!map[floor] && remaining.length) map[floor] = remaining.shift(); }
      const disp = ['5ì¸µ','4ì¸µ','3ì¸µ','2ì¸µ','1ì¸µ'];
      let outText = disp.map(f => `${f} : ${map[f].display}`).join('\n');
      if (reductions.length) outText += '\n\nâ€» ê°ì‚° ì ìš©:\n' + reductions.join(', ');
      if (noReduce.length) outText += '\n\nâ€» ê°ì‚° ì œì™¸:\n' + noReduce.join(', ');
      outText += '\n\n[ë³µì‚¬ê²°ê³¼]\n' + disp.map(f => `${f}:${map[f].nick.replace(/[^ê°€-í£A-Za-z0-9]/g,'')}`).join(', ');
      document.getElementById('btn-copy').disabled = false;
      return outText;
    }

    const inp = document.getElementById('input'), out = document.getElementById('output');
    document.getElementById('btn-assign').onclick = () => { out.value = processInput(inp.value); };
    document.getElementById('btn-clear').onclick = () => { inp.value = ''; out.value = ''; document.getElementById('btn-copy').disabled = true; };
    document.getElementById('btn-copy').onclick = () => { const m = out.value.match(/\[ë³µì‚¬ê²°ê³¼\]\n([\s\S]*)$/); if (m) navigator.clipboard.writeText(m[1].trim()).then(() => alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤:\n' + m[1].trim())); };
  });
  </script>
</body>
</html>
