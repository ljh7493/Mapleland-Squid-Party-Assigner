<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ¦‘ ì›ì–‘ì–´ì„  ìë¦¬ ë°°ì •ê¸°</title>
  <style>
    body { margin:0; padding:24px; font-family:'Malgun Gothic',sans-serif; background:#001f33; color:#fff; display:flex; flex-direction:column; align-items:center; min-height:100vh; box-sizing:border-box; }
    h1 { margin-bottom:8px; font-size:1.5rem; text-align:center; }
    .tooltip { position:relative; display:inline-block; margin-bottom:16px; cursor:help; }
    .tooltip .tiptext {
      visibility:hidden; width:340px; background:#222; color:#fff; padding:12px; border-radius:6px;
      position:absolute; z-index:1; top:100%; left:50%; transform:translateX(-40%) translateY(8px);
      opacity:0; transition:opacity 0.3s; font-size:13px; line-height:1.4; text-align:left;
    }
    .tooltip:hover .tiptext { visibility:visible; opacity:1; }
    textarea {
      width:100%; max-width:700px; height:210px; margin-bottom:16px;
      padding:12px; font-size:14px; border:none; border-radius:12px; resize:vertical;
      box-shadow:0 2px 8px rgba(0,0,0,0.2); background:#002a4d; color:#eee;
    }
    .button-group { display:flex; gap:12px; margin-bottom:12px; width:100%; max-width:700px; }
    button {
      padding:10px 18px; font-size:14px; border:none; border-radius:8px;
      cursor:pointer; background:#004aad; color:#fff; transition:0.2s;
    }
    button:disabled { background:#555!important; cursor:not-allowed; }
    button:hover:enabled { background:#003080; }
    @media(max-width:600px){ .button-group{justify-content:center;} }
  </style>
</head>
<body>
  <h1>ğŸ¦‘ ì›ì–‘ì–´ì„  ìë¦¬ ë°°ì •ê¸°</h1>
  <div class="tooltip">
    <div class="tiptext">
      <strong>ë°°ì • ê¸°ì¤€ ìš”ì•½</strong><br>
      â€¢ ìˆ«ì ê¸¸ì´ë¡œ êµ¬ë¶„: 2~3ìë¦¬â†’ë ˆë²¨, 4ìë¦¬ ì´ìƒâ†’ê³µê²©ë ¥, 1ìë¦¬â†’ë¬´ì‹œ<br>
      â€¢ ê³µê²©ë ¥ ë’¤ â€œë©”ìš©/ë©”â€ í‘œì‹œ ì‹œ 5% ê°ì‚°<br>
      â€¢ ë ˆë²¨ 97ë¯¸ë§Œ ì‹œ ë ˆë²¨ì°¨ Ã—1% ì¶”ê°€ ê°ì‚°<br>
      â€¢ ê³µê²©ë ¥ ë¹„êµ ì‹œ ë ˆì¸ì € ê¸°ì¤€ ë³´ì •ê°’ ì ìš©:<br>
        â€“ ë‚˜ì´íŠ¸ë¡œë“œ(+550), í—ˆë°‹(+500), ì €ê²©ìˆ˜Â·ì‹ ê¶(âˆ’150)<br>
      â€¢ íŠ¹ì • ì§ì—… ìš°ì„  ë°°ì¹˜:<br>
        â€“ ì‹œí”„ë§ˆìŠ¤í„°ëŠ” 4ì¸µ ê³ ì •<br>
        â€“ í¬ë£¨ì„¸ì´ë”Â·ìš©ê¸°ì‚¬ëŠ” í•œ ëª…ì´ë©´ 4ì¸µ, ë‘ ëª… ì´ìƒì´ë©´ 1ì¸µÂ·4ì¸µ ë°°ì¹˜<br>
      â€¢ ì„ ì¥(1ë²ˆ)ì€ ì •ë³´ ëˆ„ë½ ì‹œì—ë„ 5ì¸µ í™•ì • ë°°ì¹˜<br>
      <br>â€» ì ˆëŒ€ì ì¸ ê¸°ì¤€ì´ ì•„ë‹Œ ë‹¨ìˆœ ì°¸ê³ ìš©ì…ë‹ˆë‹¤.<br>ê²°ê³¼ ì´ìƒ ì‹œ ì ì ˆíˆ íŒë‹¨í•˜ì—¬ ë°°ì •í•˜ì„¸ìš”.
    </div>
  </div>

  <textarea id="input" placeholder="êµ¬ì¸ê¸€ì„ ë¶™ì—¬ë„£ì–´ì£¼ì„¸ìš”. ì˜¤ë¥˜ ì‹œ '/' ë˜ëŠ” ê³µë°± í™•ì¸"></textarea>
  <div class="button-group">
    <button id="btn-assign">ë°°ì •í•˜ê¸°</button>
    <button id="btn-clear">ì§€ìš°ê¸°</button>
    <button id="btn-copy" disabled>ê²°ê³¼ë³µì‚¬</button>
  </div>
  <textarea id="output" readonly placeholder="ë°°ì • ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤."></textarea>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const inp = document.getElementById('input');
      const out = document.getElementById('output');
      const btnAssign = document.getElementById('btn-assign');
      const btnClear = document.getElementById('btn-clear');
      const btnCopy = document.getElementById('btn-copy');

      btnAssign.addEventListener('click', function() {
        out.value = processInput(inp.value);
        btnCopy.disabled = !/\[ë³µì‚¬ê²°ê³¼\]/.test(out.value);
      });
      btnClear.addEventListener('click', function() {
        inp.value = '';
        out.value = '';
        btnCopy.disabled = true;
      });
      btnCopy.addEventListener('click', function() {
        const m = out.value.match(/\[ë³µì‚¬ê²°ê³¼\]\n([\s\S]*)$/);
        if (m) {
          const text = m[1].trim();
          navigator.clipboard.writeText(text).then(function() {
            alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤:\n' + text);
          });
        }
      });

      // Parsing & Assignment Logic
      const jobMap = {
        ë³´ë§ˆ:'ë³´ìš°ë§ˆìŠ¤í„°', ì‹ ê¶:'ì‹ ê¶', ë³´ìš°ë§ˆìŠ¤í„°:'ë³´ìš°ë§ˆìŠ¤í„°',
        ë Œ:'ë ˆì¸ì €', ë Œì ¸:'ë ˆì¸ì €', ë ˆì¸ì ¸:'ë ˆì¸ì €', ë ê±°:'ë ˆì¸ì €', ë ˆì¸ì €:'ë ˆì¸ì €',
        ì €ê²©:'ì €ê²©ìˆ˜', ì €ìˆ˜:'ì €ê²©ìˆ˜', ì €ê²©ìˆ˜:'ì €ê²©ìˆ˜', í—ˆë°‹:'í—ˆë°‹', í‘œë„:'í—ˆë°‹', í—ˆ:'í—ˆë°‹',
        ë‚˜ë¡œ:'ë‚˜ì´íŠ¸ë¡œë“œ', ë‚˜ì´íŠ¸ë¡œë“œ:'ë‚˜ì´íŠ¸ë¡œë“œ', ìš©:'ìš©ê¸°ì‚¬', ìš©ê¸°ì‚¬:'ìš©ê¸°ì‚¬',
        í¬ë£¨:'í¬ë£¨ì„¸ì´ë”', í¬ë£¨ì„¸ì´ë”:'í¬ë£¨ì„¸ì´ë”', ì‹œí”„:'ì‹œí”„ë§ˆìŠ¤í„°', ì‹œí”„ë§ˆìŠ¤í„°:'ì‹œí”„ë§ˆìŠ¤í„°', ì‹œë§ˆ:'ì‹œí”„ë§ˆìŠ¤í„°',
        ë‹¤í¬ë‚˜ì´íŠ¸:'ë‹¤í¬ë‚˜ì´íŠ¸', ë‹¼ë‚˜:'ë‹¤í¬ë‚˜ì´íŠ¸', í˜€ë¡œ:'íˆì–´ë¡œ', íˆì–´ë¡œ:'íˆì–´ë¡œ', ì„€ë„ì–´:'ì„€ë„ì–´'
      };
      const conv = { ë‚˜ì´íŠ¸ë¡œë“œ:550, í—ˆë°‹:500, ì €ê²©ìˆ˜:-150, ì‹ ê¶:-150 };

      function parseLine(line) {
        let txt = line.replace(/^\d+\s*(?:\.\s*)?/, '').replace(/[\[\]():]/g, '/').trim();
        const parts = txt.split(/[\/\s]+/).filter(Boolean);
        let lvlRaw = '', atkRaw = '', buffTag = '', jobRaw = '', nick = [];
        parts.forEach(tk => {
          if (/^\d{4,}\+*(?:ë©”ì—…|ë©”ì—…M|ë©”ì†Œì—…|ë©”ì†Œì—…M)$/i.test(tk)) {
            if (!atkRaw) atkRaw = tk.match(/^(\d{4,}\+*)/)[1];
            return;
          }
          if (/^ë©”ìš©$/i.test(tk)) { buffTag = 'ë©”ìš©'; return; }
          const mMe = tk.match(/^(\d{4,}\+*)\(ë©”ìš©\)$/i);
          if (mMe) { if (!atkRaw) atkRaw = mMe[1]; buffTag = 'ë©”ìš©'; return; }
          if (!lvlRaw && /^\d{2,3}n?$/i.test(tk)) { lvlRaw = tk; return; }
          if (!atkRaw && /^\d{4,}\+*$/.test(tk)) { atkRaw = tk; return; }
          const norm = jobMap[tk.toLowerCase()];
          if (!jobRaw && norm) { jobRaw = norm; return; }
          nick.push(tk);
        });
        if (!atkRaw && ['ë³´ìš°ë§ˆìŠ¤í„°','ì‹ ê¶'].includes(jobRaw)) atkRaw = '9999+';
        if (!lvlRaw) lvlRaw = '?';
        if (!jobRaw) jobRaw = 'ë³´ìš°ë§ˆìŠ¤í„°';
        if (!nick.length || !atkRaw) throw new Error('í•„ìˆ˜ í•„ë“œ ëˆ„ë½');
        return { nick: nick.join(' '), lvlRaw, jobRaw, atkRaw, buffTag };
      }

      function processInput(text) {
        const lines = text.split('\n').map(l => l.trim());
        let players = [], errors = [], reductions = [], noReduce = [];

        lines.forEach(line => {
          if (!/^\d+\./.test(line)) return;
          let useLine = line;
          const idx = parseInt(line, 10);
          if (idx === 1 && !line.includes('/')) {
            const lvlM = line.match(/(\d{2,3}n?)/i);
            const atkM = line.match(/(\d{4,}\+*)/);
            useLine = `1. ì„ ì¥/${lvlM ? lvlM[1] : '?'}/ë³´ìš°ë§ˆìŠ¤í„°/${atkM ? atkM[1] : ''}`;
          }
          try {
            const { nick, lvlRaw, jobRaw, atkRaw, buffTag } = parseLine(useLine);
            const rawAtk = parseInt(atkRaw, 10);
            let lvl = parseInt(lvlRaw) || 97;
            let unknown = false;
            if (lvlRaw === '?' || /n$/i.test(lvlRaw)) {
              unknown = true;
              lvl = 97;
              noReduce.push(`${nick}(ë ˆë²¨ë¯¸í™•ì¸)`);
            }
            if (!unknown && lvl < 92) throw '';
            let adj = rawAtk;
            if (buffTag === 'ë©”ìš©') {
              const bef = adj;
              adj = Math.round(adj / 1.05);
              reductions.push(`${nick}/${bef}â†’${adj}(ë©”ìš© ê°ì‚°)`);
            }
            if (!unknown && lvl < 97) {
              const bef = adj;
              const pct = (97 - lvl) / 100;
              adj = Math.round(adj * (1 - pct));
              reductions.push(`${nick}/${bef}â†’${adj}(ë ˆë²¨${Math.round(pct * 100)}%)`);
            }
            players.push({ nick, lvl, job: jobRaw, adj, comp: adj + (conv[jobRaw] || 0), display: `${nick}/${lvlRaw}/${jobRaw}/${atkRaw}` });
          } catch (e) {
            errors.push(line);
          }
        });

        if (players.length < 5) {
          return 'ë°°ì • ì‹¤íŒ¨\nâ€» íŒŒì‹± ì‹¤íŒ¨ ë¼ì¸:\n' + errors.join('\n');
        }

        // Sort by combined power
        players.sort((a, b) => b.comp - a.comp);
        const map = {};
        let rem = [...players];

        // 1) ì‹œí”„ë§ˆìŠ¤í„° 4ì¸µ ê³ ì •
        const sh = rem.find(p => p.job === 'ì‹œí”„ë§ˆìŠ¤í„°');
        if (sh) {
          map['4ì¸µ'] = sh;
          rem.splice(rem.indexOf(sh), 1);
        }

        // 2) í¬ë£¨ì„¸ì´ë”Â·ìš©ê¸°ì‚¬ ì²˜ë¦¬
        const grp = rem.filter(p => ['í¬ë£¨ì„¸ì´ë”', 'ìš©ê¸°ì‚¬'].includes(p.job))
                       .sort((a, b) => b.comp - a.comp);
        if (grp.length === 1) {
          map['4ì¸µ'] = grp[0];
          rem.splice(rem.indexOf(grp[0]), 1);
        } else if (grp.length >= 2) {
          map['1ì¸µ'] = grp[0];
          map['4ì¸µ'] = grp[1];
          rem.splice(rem.indexOf(grp[0]), 1);
          rem.splice(rem.indexOf(grp[1]), 1);
        }

        // 3) ë‚˜ë¨¸ì§€ ë‚¨ì€ ì¸µ ìˆœì„œëŒ€ë¡œ ì±„ìš°ê¸° (5,3,2,1ì¸µ)
                        // 3) ë‚˜ë¨¸ì§€ ë‚¨ì€ ì¸µ ìˆœì„œëŒ€ë¡œ ì±„ìš°ê¸° (ìš°ì„ ìˆœìœ„: 5 > 3 > 1 > 2 > 4)
        ['5ì¸µ','3ì¸µ','1ì¸µ','2ì¸µ','4ì¸µ'].forEach(f => {
          if (!map[f] && rem.length) {
            map[f] = rem.shift();
          }
        });
        const floors = ['5ì¸µ','4ì¸µ','3ì¸µ','2ì¸µ','1ì¸µ'];
        let out = floors.map(f => `${f} : ${map[f].display}`).join('\n');
        if (reductions.length) out += '\n\nâ€» ê°ì‚° ì ìš©:\n' + reductions.join(', ');
        if (noReduce.length) out += '\n\nâ€» ê°ì‚° ì œì™¸:\n' + noReduce.join(', ');
        out += '\n\n[ë³µì‚¬ê²°ê³¼]\n' + floors.map(f => `${f}:${map[f].nick.replace(/[^ê°€-í£A-Za-z0-9]/g,'')}`).join(', ');

        return (btnCopy.disabled = false), out;
      }
    });
  </script>
</body>
</html>
